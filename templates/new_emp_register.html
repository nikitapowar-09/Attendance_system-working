<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register Here</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}"> -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
</head>
<body>
  <!-- Navbar -->
  <header>
    <div class="navbar">
        <h1 style="color: white;">VisagFace</h1>
        <nav>
          <div class="nav-links">
            <a href="{{ url_for('admin_dashboard') }}">Home</a>
            <a href="{{ url_for('view_attendance') }}">Check Attendance</a>
            <a href="{{ url_for('manage_leaves') }}">Check Request</a>
            <a href="#">New Registration</a>
            <a href="{{ url_for('logout') }}">Logout</a>
          </div>
        </nav>
    </div>
  </header>

  <!-- Registration Section -->
  <section id="register-section" class="container mt-5" style="max-width: 900px; text-align: center; background-color: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);">
    <h4 class="text-center">Register an Employee</h4>

    <div class="text-center">
      {% if not session.img_captured %}
      <p class="text-muted">
        Instructions:<br>
        1. Click the button below to open the camera.<br>
        2. Press <strong>'C'</strong> to capture the image.
      </p>
      {% endif %}
      
      {% if temp_pic %}
      <img src="{{ url_for('static', filename='images/users/temp.jpg') }}?xxx={{ session['dt'] }}" height="300" width="300">
  {% else %}
      <img src="{{ url_for('static', filename='images/no-image.png') }}?xxx={{ session['dt'] }}" height="300" width="300">
  {% endif %}
  <p class="text-muted">Employee Image</p>
  
  {% if not session.get('img_captured') %}
      <a href="/capture_image" class="btn btn-lg btn-warning">Open Camera</a>
  {% endif %}
  
    </div>

    <br><br>

    {% if session.img_captured %}
    <form method="POST">
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="inputName">Name</label>
          <input type="text" name='name' class="form-control" placeholder="Enter Employee name" id="inputName" required>
        </div>
        <div class="form-group col-md-4">
          <label for="inputRoll">Employee Id</label>
          <input type="text" name='employee_id' class="form-control" placeholder="Enter Employee Id" id="inputRoll" required>
        </div>
        <div class="form-group col-md-4">
          <label for="inputSem">Phone No.</label>
          <input type="tel" name="Phone" class="form-control" placeholder="Enter Phone No." id="inputPh" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
            <label for="email">Email (for OTP):</label>
            <input type="email" name="email" id="email" class="form-control" placeholder="Employee Email Id" required>
            <button type="button" id="send-otp-btn" class="btn btn-secondary mt-2">Send OTP</button>
            <p id="otp-status" class="text-success"></p>
        </div>
    
        <div class="form-group col-md-6">
          <label for="otp">Enter OTP:</label>
          <input type="text" name="otp" id="otp" class="form-control" placeholder="Enter OTP" required>
          <button type="button" id="verify-otp-btn" class="btn btn-secondary mt-2">Verify</button>
          <p id="otp-verify-status" class="text-success"></p>
        </div>
      </div>

      <div class="form-group col-md-6">
        <label for="inputPassword4">Password</label>
        <input type="password" name="password" class="form-control" id="inputPassword4" placeholder="Password" required>
      </div>

      <!-- <h3>Admin Info</h3>
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="inputEmail4">Email</label>
          <input type="email" name="email" class="form-control" id="inputEmail4" placeholder="Email" required>
        </div>
        
      </div> -->

      <button type="submit" class="btn btn-primary">Register Employee</button>
    </form>
    {% endif %}
  </section>

  <!-- Footer -->
  <footer>
    <p>&copy; 2024 VisagFace. All rights reserved.</p>
  </footer>

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='js/register.js') }}"></script>
  <script src="{{ url_for('static', filename='js/Camera.js') }}"></script>
  <script src="{{ url_for('static', filename='js/face-api.js-models-master/main.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Send OTP
    document.getElementById("send-otp-btn").addEventListener("click", function() {
      const email = document.getElementById("email").value;
  
      fetch("/verify", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `email=${encodeURIComponent(email)}`
      })
      .then(response => {
        if (response.ok) {
          Swal.fire({
            icon: 'success',
            title: 'OTP Sent!',
            text: `OTP has been sent to ${email}`,
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          throw new Error("OTP sending failed");
        }
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: 'Failed!',
          text: "Could not send OTP. Please try again.",
          timer: 2000,
          showConfirmButton: false
        });
        console.error(error);
      });
    });
  
    // Verify OTP
    document.getElementById("verify-otp-btn").addEventListener("click", function() {
      const otp = document.getElementById("otp").value;
  
      fetch("/validate", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `otp=${encodeURIComponent(otp)}`
      })
      .then(response => response.text())
      .then(data => {
        if (data.includes("âœ…")) {
          Swal.fire({
            icon: 'success',
            title: 'OTP Verified!',
            text: 'Your email has been verified successfully.',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Invalid OTP!',
            text: 'Please try again.',
            timer: 2000,
            showConfirmButton: false
          });
        }
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: 'Verification Error!',
          text: 'Something went wrong during verification.',
          timer: 2000,
          showConfirmButton: false
        });
        console.error(error);
      });
    });
    
    // Open Camera (if needed)
    document.getElementById('startCamera').onclick = function() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
          document.getElementById('videoElement').srcObject = stream;
        })
        .catch(function(error) {
          console.log("Error accessing the camera: ", error);
        });
    };
  
    // When the registration form is successfully submitted
    document.querySelector('form').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent the form from submitting the traditional way
  
      // Perform the fetch or AJAX request to submit the form data
      fetch('/register_employee', {
        method: 'POST',
        body: new FormData(this)
      })
      .then(response => {
        if (response.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Employee Registered!',
            text: 'The employee has been successfully registered.',
            timer: 2000,
            showConfirmButton: false
          });
  
          // Reset the form after successful registration
          resetForm();
        } else {
          throw new Error("Registration failed");
        }
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: 'Something went wrong. Please try again.',
          timer: 2000,
          showConfirmButton: false
        });
        console.error(error);
      });
    });
  
    // Function to reset the form and clear image/video
    function resetForm() {
      // Reset the form fields
      document.querySelector('form').reset();
  
      // Clear the image preview or captured video
      const videoElement = document.getElementById('videoElement');
      const imagePreview = document.getElementById('imagePreview');
      
      // Clear video stream (if camera was used)
      if (videoElement && videoElement.srcObject) {
        const stream = videoElement.srcObject;
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
        videoElement.srcObject = null;
      }
  
      // Clear the image preview
      if (imagePreview) {
        imagePreview.src = ''; // Remove the preview image source
      }
  
      // If there's a file input, reset it
      const fileInput = document.querySelector('input[type="file"]');
      if (fileInput) {
        fileInput.value = ''; // Reset file input
      }
    }
  
    // Call resetForm on page load to ensure initial state
    window.addEventListener('load', resetForm);

  function resetCapturedImage() {
    // Clear the image preview
    const imagePreview = document.getElementById('imagePreview');
    if (imagePreview) {
      imagePreview.src = '';  // Clear the preview image source
    }

    // Stop the video stream if it's playing (optional)
    const videoElement = document.getElementById('videoElement');
    if (videoElement && videoElement.srcObject) {
      const stream = videoElement.srcObject;
      const tracks = stream.getTracks();
      tracks.forEach(track => track.stop()); // Stop all tracks of the stream
      videoElement.srcObject = null; // Reset the video stream
    }
}

  </script>
  
  
  
  <!-- Bootstrap JS and Popper JS -->
  <script src="{{ url_for('static', filename='jquery-3.2.1.slim.min.js') }}" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='popper.min.js') }}" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='bootstrap.min.js') }}" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>
